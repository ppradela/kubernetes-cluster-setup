# ‚ò∏Ô∏è Kubernetes Cluster Bootstrap

This guide walks you through setting up a **secure and modern Kubernetes cluster** using kubeadm, Firewalld, Flannel, and MetalLB.

---

## üìë Table of Contents
1. [Introduction](#-introduction)  
2. [Cluster Architecture](#-cluster-architecture)  
3. [Initial Node Preparation](#-initial-node-preparation)  
4. [Firewalld Configuration](#-firewalld-configuration)  
5. [Install Container Runtime & K8s Tools](#-install-container-runtime--k8s-tools)  
6. [Bootstrap the Control Plane](#-bootstrap-the-control-plane)  
7. [Install the CNI (Flannel)](#-install-the-cni-flannel)  
8. [Join Worker Nodes](#-join-worker-nodes)  
9. [Install the Load Balancer (MetalLB)](#-install-the-load-balancer-metallb)  
10. [Verification & Example Deployment](#-verification--example-deployment)  
11. [Author](#-author)

---

## üìù Introduction
This guide provides a **step-by-step process** for bootstrapping a Kubernetes cluster with a strong focus on **security and reliability**. It integrates best practices for `firewalld` using a multi-zone approach, ensuring robust host-level network security.

---

## üó∫Ô∏è Cluster Architecture
- **Control Plane:** 1 Node  
- **Worker Nodes:** 3 Nodes  
- **Operating System:** [Fedora Server](https://fedoraproject.org/server/)  
- **Container Runtime:** [cri-o](https://cri-o.io/)  
- **CNI (Pod Network):** [flannel-io](https://github.com/flannel-io/flannel)  
- **Load Balancer:** [MetalLB (Layer 2 Mode)](https://metallb.io/)  

---

## üõ†Ô∏è Initial Node Preparation
Perform these steps on **all nodes**.

### 1. Update system & set hostnames
```bash
sudo dnf update -y
sudo dnf install iptables iproute-tc -y
```

Set hostnames:
```bash
sudo hostnamectl set-hostname k8s-control-plane
sudo hostnamectl set-hostname k8s-worker-01
sudo hostnamectl set-hostname k8s-worker-02
sudo hostnamectl set-hostname k8s-worker-03
```

Update `/etc/hosts` with cluster IPs and hostnames.

### 2. Disable Swap
```bash
sudo systemctl stop swap-create@zram0
sudo dnf remove zram-generator-defaults -y
sudo reboot now
```

### 3. Kernel Modules & Sysctl
```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
```

---

## üî• Firewalld Configuration
We will configure **three zones**: `public`, `k8s-cluster`, and `flannel`.

### Base Setup (all nodes)
```bash
sudo firewall-cmd --add-masquerade --permanent
sudo firewall-cmd --permanent --new-zone=k8s-cluster
sudo firewall-cmd --permanent --new-zone=flannel

sudo firewall-cmd --permanent --zone=k8s-cluster --add-source=192.168.122.0/24
sudo firewall-cmd --permanent --zone=flannel --add-source=10.244.0.0/16
sudo firewall-cmd --permanent --zone=flannel --set-target=ACCEPT
```

### Control Plane Rules
```bash
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=6443/tcp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=8472/udp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=7946/tcp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=7946/udp
sudo firewall-cmd --permanent --zone=public --add-service=ssh
```

### Worker Node Rules
```bash
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=10250/tcp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=8472/udp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=7946/tcp
sudo firewall-cmd --permanent --zone=k8s-cluster --add-port=7946/udp

sudo firewall-cmd --permanent --zone=public --add-port=30000-32767/tcp
sudo firewall-cmd --permanent --zone=public --add-port=30000-32767/udp
sudo firewall-cmd --permanent --zone=public --add-service=ssh
```

### Reload Rules
```bash
sudo firewall-cmd --reload
```

---

## üì¶ Install Container Runtime & K8s Tools
### CRI-O
```bash
sudo dnf install cri-o containernetworking-plugins -y
sudo systemctl enable --now crio
```

### Kubernetes Tools
```bash
sudo dnf install kubernetes kubernetes-kubeadm kubernetes-client -y
sudo systemctl enable --now kubelet
```

---

## üöÄ Bootstrap the Control Plane
On **control plane only**:
```bash
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

Configure `kubectl`:
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

---

## üåê Install the CNI (Flannel)
```bash
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
kubectl get pods -n kube-system
kubectl get nodes
```

---

## üîó Join Worker Nodes
Use the `kubeadm join` command generated by `kubeadm init`.
```bash
sudo kubeadm join <control-plane-ip>:6443 --token <token> \
 --discovery-token-ca-cert-hash sha256:<hash>
```

Verify from control plane:
```bash
kubectl get nodes -o wide
```

---

## ‚öñÔ∏è Install the Load Balancer (MetalLB)
```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml
```

Create `metallb-config.yaml`:
```yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.122.240-192.168.122.250
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
```

```bash
kubectl apply -f metallb-config.yaml
```

---

## ‚úÖ Verification & Example Deployment
Deploy NGINX:
```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=LoadBalancer
kubectl get svc nginx
```

Test:
```bash
curl http://<EXTERNAL-IP>
```

---

## üë§ Author
**Przemyslaw Pradela**  
- üíº GitHub: [@ppradela](https://github.com/ppradela)  
- ‚úâÔ∏è Email: [przemyslaw.pradela@gmail.com](mailto:przemyslaw.pradela@gmail.com?subject=Kubernetes%20Cluster%20Bootstrap%20Guide)  
- üîó LinkedIn: [przemyslaw-pradela](https://www.linkedin.com/in/przemyslaw-pradela)

